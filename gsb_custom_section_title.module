<?php

/**
 * @file
 * Allows customized section titles.
 */

/**
 * Implements hook_menu().
 */
function gsb_custom_section_title_menu() {
  $items = array();
  $items['admin/config/user-interface/gsb-custom-section-title'] = array(
    'title' => 'GSB Custom Section Titles',
    'description' => 'Manage custom section titles',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gsb_custom_section_title_form'),
    // @todo.
    'access callback' => TRUE,
    'file' => 'gsb_custom_section_title.admin.inc',
  );
  $items['gsb_custom_section_title/%ctools_js/delete/%'] = array(
    'page callback' => 'gsb_custom_section_title_delete_section',
    'page arguments' => array(3, 1),
    // @todo.
    'access callback' => TRUE,
    'theme callback' => 'ajax_base_page_theme',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Gets the custom section titles.
 *
 * @param null $key
 *   (optional) If specified, returns the section title for a given key.
 *
 * @return array
 *   An array of custom section titles.
 */
function gsb_custom_section_title_get_sections($key = NULL) {
  $data = variable_get('gsb_custom_section_title_sections', array());
  if ($key) {
    return isset($data[$key]) ? $data[$key] : array();
  }
  return $data;
}

/**
 * Sets the custom section titles.
 *
 * @param array $sections
 *   An array of custom section titles.
 */
function gsb_custom_section_title_set_sections(array $sections) {
  $sections = array_values($sections);
  foreach ($sections as $key => $section) {
    $section['id'] = $key;
  }
  variable_set('gsb_custom_section_title_sections', $sections);
}

/**
 * Implements hook_theme().
 */
function gsb_custom_section_title_theme() {
  return array(
    'gsb_custom_section_title_form' => array(
      'render element' => 'form',
    ),
  );
}

/**
 * Deletes a section title.
 *
 * @param int $id
 *   The unique identifier for this row.
 * @param bool $js
 *   Whether this form was submitted via AJAX or not. Defaults to FALSE.
 */
function gsb_custom_section_title_delete_section($id, $js = FALSE) {
  if (isset($_GET['token']) && drupal_valid_token($_GET['token'], $id)) {
    $sections = gsb_custom_section_title_get_sections();
    unset($sections[$id]);
    gsb_custom_section_title_set_sections($sections);
    if ($js) {
      // If there are no more sections, remove the whole table.
      if (empty($sections)) {
        $id = 'table';
      }
      $commands[] = ajax_command_remove("#gsb-custom-section-title-$id");
      print ajax_render($commands);
      drupal_exit();
    }
  }
  else {
    drupal_goto('admin/config/user-interface/gsb-custom-section-title');
  }
}
